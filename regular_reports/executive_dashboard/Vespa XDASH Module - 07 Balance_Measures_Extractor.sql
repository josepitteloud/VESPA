 /*--------------------------------------------------------------------------------------------------------------**Project Name: 					Vespa Executive Dashboard**Analysts:							Angel Donnarumma (angel.donnarumma_mirabel@skyiq.co.uk)**Lead(s):							Jose Loureda**Stakeholder:						Vespa Directors / Managers.**Due Date:							22/02/2013**Project Code (Insight Collation):	**Sharepoint Folder:				http://rtci/Sky%20Projects/Forms/AllItems.aspx?RootFolder=%2fSky%20Projects%2fVespa%2fRegular%20reports									%2fMeta%2fExecutive%20Dashboard&FolderCTID=&View={95B15B22-959B-4B62-809A-AD43E02001BD}									**Business Brief:Module responsible for extracting and deriving balance metrics coming from the Panel Management and Scaling process for analysing panel balance...**Module's Sections:M07: Panel Balance Measures Extractor		M07.0 - Initialising environment		M07.1 - Deriving Metric(s)		M07.2 - QAing results		M07.3 - Returning results--------------------------------------------------------------------------------------------------------------*/--------------------------------------/* M07.0 - Initialising environment */--------------------------------------create or replace procedure vespa_sp_xdash_m07_panelbalanceextractasbegin--------------------------------/* M07.1 - Deriving Metric(s) */---------------------------------- traffic lights only for Daily Panel...select  lights.variable_name        ,lights.vespa_imbalance        ,measures.Cat_convergence        ,measures.Convergence_stdfrom    (            select  variable_name                    ,min(sequencer)                                                     as _sequencer                    ,sum(case when panel = 'DP' then imbalance_rating else 0 end)    as vespa_imbalance            from    vespa_analysts.vespa_PanMan_09_traffic_lights            where   sequencer < 7            group   by  variable_name        ) as lights        inner join  (                        select  1 /*UNIVERSE*/      as sequencer                                ,sum(abs(diff))     as Cat_convergence                                ,stddev(diff)       as Convergence_std                        from    (                                    select  sum(weights.sky_base_accounts)                      as Sky_base											,sum(weights.vespa_accounts * weights.weighting)    as convergence_											,sky_base - convergence_                            as diff									from    (												select  distinct scaling_segment_id												from    vespa_analysts.Vespa_PanMan_Scaling_Segment_Profiling 												where   panel = 'DP'											)                                               	as ssp											inner join vespa_analysts.SC2_Segments_Lookup_v2_1  as ssl 											on  ssp.scaling_segment_ID = ssl.scaling_segment_ID											inner join vespa_analysts.sc2_weightings        as weights											on  ssp.scaling_segment_id = weights.scaling_segment_id											and weights.scaling_day =   ( 																			select max(scaling_date) as thedate																			from vespa_analysts.SC2_Metrics																		)                                    group   by  ssl.universe                                ) as base                        union                        select  2 /*REGION*/        as sequencer                                ,sum(abs(diff))     as Cat_convergence                                ,stddev(diff)       as Convergence_std                        from    (                                    select  sum(weights.sky_base_accounts)                      as Sky_base											,sum(weights.vespa_accounts * weights.weighting)    as convergence_											,sky_base - convergence_                            as diff									from    (												select  distinct scaling_segment_id												from    vespa_analysts.Vespa_PanMan_Scaling_Segment_Profiling 												where   panel = 'DP'											)                                               	as ssp											inner join vespa_analysts.SC2_Segments_Lookup_v2_1  as ssl 											on  ssp.scaling_segment_ID = ssl.scaling_segment_ID											inner join vespa_analysts.sc2_weightings        as weights											on  ssp.scaling_segment_id = weights.scaling_segment_id											and weights.scaling_day =   ( 																			select max(scaling_date) as thedate																			from vespa_analysts.SC2_Metrics																		)                                    group   by  ssl.isba_tv_region                                ) as base                        union                        select  3 /*HHComposition*/ as sequencer                                ,sum(abs(diff))     as Cat_convergence                                ,stddev(diff)       as Convergence_std                        from    (                                    select  sum(weights.sky_base_accounts)                      as Sky_base											,sum(weights.vespa_accounts * weights.weighting)    as convergence_											,sky_base - convergence_                            as diff									from    (												select  distinct scaling_segment_id												from    vespa_analysts.Vespa_PanMan_Scaling_Segment_Profiling 												where   panel = 'DP'											)                                               	as ssp											inner join vespa_analysts.SC2_Segments_Lookup_v2_1  as ssl 											on  ssp.scaling_segment_ID = ssl.scaling_segment_ID											inner join vespa_analysts.sc2_weightings        as weights											on  ssp.scaling_segment_id = weights.scaling_segment_id											and weights.scaling_day =   ( 																			select max(scaling_date) as thedate																			from vespa_analysts.SC2_Metrics																		)                                    group   by  ssl.hhcomposition                                ) as base                        union                        select  4 /*PACKAGE*/       as sequencer                                ,sum(abs(diff))     as Cat_convergence                                ,stddev(diff)       as Convergence_std                        from    (                                    select  sum(weights.sky_base_accounts)                      as Sky_base											,sum(weights.vespa_accounts * weights.weighting)    as convergence_											,sky_base - convergence_                            as diff									from    (												select  distinct scaling_segment_id												from    vespa_analysts.Vespa_PanMan_Scaling_Segment_Profiling 												where   panel = 'DP'											)                                               	as ssp											inner join vespa_analysts.SC2_Segments_Lookup_v2_1  as ssl 											on  ssp.scaling_segment_ID = ssl.scaling_segment_ID											inner join vespa_analysts.sc2_weightings        as weights											on  ssp.scaling_segment_id = weights.scaling_segment_id											and weights.scaling_day =   ( 																			select max(scaling_date) as thedate																			from vespa_analysts.SC2_Metrics																		)                                    group   by  ssl.package                                ) as base                        union                        select  5 /*TENURE*/        as sequencer                                ,sum(abs(diff))     as Cat_convergence                                ,stddev(diff)       as Convergence_std                        from    (                                    select  sum(weights.sky_base_accounts)                      as Sky_base											,sum(weights.vespa_accounts * weights.weighting)    as convergence_											,sky_base - convergence_                            as diff									from    (												select  distinct scaling_segment_id												from    vespa_analysts.Vespa_PanMan_Scaling_Segment_Profiling 												where   panel = 'DP'											)                                               	as ssp											inner join vespa_analysts.SC2_Segments_Lookup_v2_1  as ssl 											on  ssp.scaling_segment_ID = ssl.scaling_segment_ID											inner join vespa_analysts.sc2_weightings        as weights											on  ssp.scaling_segment_id = weights.scaling_segment_id											and weights.scaling_day =   ( 																			select max(scaling_date) as thedate																			from vespa_analysts.SC2_Metrics																		)                                    group   by  ssl.tenure                                ) as base                        union                        select  6 /*BOX TYPE*/      as sequencer                                ,sum(abs(diff))     as Cat_convergence                                ,stddev(diff)       as Convergence_std                        from    (                                    select  sum(weights.sky_base_accounts)                      as Sky_base											,sum(weights.vespa_accounts * weights.weighting)    as convergence_											,sky_base - convergence_                            as diff									from    (												select  distinct scaling_segment_id												from    vespa_analysts.Vespa_PanMan_Scaling_Segment_Profiling 												where   panel = 'DP'											)                                               	as ssp											inner join vespa_analysts.SC2_Segments_Lookup_v2_1  as ssl 											on  ssp.scaling_segment_ID = ssl.scaling_segment_ID											inner join vespa_analysts.sc2_weightings        as weights											on  ssp.scaling_segment_id = weights.scaling_segment_id											and weights.scaling_day =   ( 																			select max(scaling_date) as thedate																			from vespa_analysts.SC2_Metrics																		)                                    group   by  ssl.boxtype                                ) as base                    )   as measures        on  lights._sequencer = measures.sequencerorder   by  _sequencer---------------------------/* M07.2 - QAing results */----------------------------- coming soon...-------------------------------/* M07.3 - Returning results */--------------------------------- NYIP...end;commit; -------------------------------------- END
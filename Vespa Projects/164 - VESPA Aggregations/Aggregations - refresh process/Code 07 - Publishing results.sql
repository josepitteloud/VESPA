/*###############################################################################
# Created on:   12/09/2013
# Created by:   Sebastian Bednaszynski (SBE)
# Description:  VESPA Aggregations - publishing results to summary tables
#
# List of steps:
#               STEP 0.1 - preparing environment
#               STEP 1.0 - table with raw values
#               STEP 2.0 - table with low level values
#               STEP 3.0 - table with high level values
#
#################################################################################
# Dependencies
# ------------------------------------------------------------------------------
# => Tables/objects required:
#     - VESPA_Shared.Aggr_Summary_Raw_All
#     - VESPA_Shared.Aggr_Summary_Low_Level_All
#     - VESPA_Shared.Aggr_Summary_High_Level_All
#     - VESPA_Shared.Aggr_Fact
#     - VESPA_Shared.Aggr_Period_Dim
#     - VESPA_Shared.Aggr_Metric_Group_Dim
#
#################################################################################
# Change log
# ------------------------------------------------------------------------------
# 28/08/2013  SBE   v01 - initial version
# 01/11/2013  SBE   New summary table versions, new metrics added
# 12/11/2013  SBE   New aggregations added (Programme genres & Top channels)
# 26/11/2013  SBE   Removal of previous results added in case of re-run exercise
# 13/01/2014  SBE   Additional parameters added to support selective execution of
#                   each summary to handle DB disconnections
# 21/02/2014  SBE   Commentary added
#
###############################################################################*/


if object_id('VAggr_7_Publishing') is not null then drop procedure VAggr_7_Publishing end if;
create procedure VAggr_7_Publishing
      @parPeriodKey             bigint,
      @parRunRaw                bit = 1,
      @parRunLowLevel           bit = 1,
      @parRunHighLevel          bit = 1,
      @parRefreshIdentifier     varchar(40) = '',    -- Logger - refresh identifier
      @parBuildId               bigint = null        -- Logger - add events to an existing logger process
as
begin


        -- ##############################################################################################################
        -- ##### STEP 0.1 - preparing environment                                                                   #####
        -- ##############################################################################################################

        -- ###############################################################################
        -- ##### Define and set variables                                            #####
        -- ###############################################################################

      declare @varBuildId                     bigint              -- Logger ID (so all builds end up in same queue)
      declare @varProcessIdentifier           varchar(20)         -- Logger - process ID
      declare @varSQL                         varchar(25000)

      set @varProcessIdentifier        = 'VAggr_7_Publish_v01'

      if (@parBuildId is not null)
          set @varBuildId = @parBuildId

      if (@parRunRaw <> 1)
          set @parRunRaw = 0

      if (@parRunLowLevel <> 1)
          set @parRunLowLevel = 0

      if (@parRunHighLevel <> 1)
          set @parRunHighLevel = 0


        -- ###############################################################################
        -- ##### Create logger event                                                 #####
        -- ###############################################################################
      if (@parBuildId is null)
          execute logger_create_run @varProcessIdentifier, @parRefreshIdentifier, @varBuildId output

      execute logger_add_event @varBuildId, 3, '####### VESPA Aggregations [Aggregation publishing] - process started #######', null
      execute logger_add_event @varBuildId, 3, '>>>>> Step 0.1: Preparing environment <<<<<', null
      execute logger_add_event @varBuildId, 3, 'Process identifier: ' || @varProcessIdentifier, null
      execute logger_add_event @varBuildId, 3, 'Refresh identifier: ' || @parRefreshIdentifier, null
      execute logger_add_event @varBuildId, 3, 'Build ID: ' || @varBuildId, null



        -- ##############################################################################################################
        -- ##### STEP 1.0 - Table with raw values                                                                   #####
        -- ##############################################################################################################
      execute logger_add_event @varBuildId, 3, '>>>>> Step 1.0: Populating table with raw values <<<<<', null

      if (@parRunRaw = 1)
        begin

            delete from VESPA_Shared.Aggr_Summary_Raw_All
             where Period_Key = @parPeriodKey
            commit
            execute logger_add_event @varBuildId, 3, 'Existing summaries deleted (raw metrics)', @@rowcount

            insert into VESPA_Shared.Aggr_Summary_Raw_All
                   (
                    Account_Number,
                    Period_Key,
                    Period_Start,
                    Period_End,

                    Raw_AvDVw__All_TV,
                    Raw_AvDVw__Non_Premium,

                    Raw_SOV__Prem_Movies,
                    Raw_SOV__Prem_Sports,
                    Raw_SOV__Prem_ALa_Carte,
                    Raw_SOV__Pack_HD,
                    Raw_SOV__Pack_3D,
                    Raw_SOV__Prem_3rd_Party,
                    Raw_SOV__Non_Premium_Pay_TV,
                    Raw_SOV__Non_Premium_FTA_TV,
                    Raw_SOV__Recorded_Viewing,
                    Raw_SOV__All_Pay_TV,
                    Raw_SOV__Genre_Non_Prem_Children,
                    Raw_SOV__Genre_Non_Prem_Movies,
                    Raw_SOV__Genre_Non_Prem_News_Documentaries,
                    Raw_SOV__Genre_Non_Prem_Sports,
                    Raw_SOV__Genre_Non_Prem_Action_SciFi,
                    Raw_SOV__Genre_Non_Prem_Arts_Lifestyle,
                    Raw_SOV__Genre_Non_Prem_Comedy_Game_Shows,
                    Raw_SOV__Genre_Non_Prem_Drama_Crime,
                    Raw_SOV__Genre_Prem_Movies_Action_Adventure,
                    Raw_SOV__Genre_Prem_Movies_Comedy,
                    Raw_SOV__Genre_Prem_Movies_Drama_Romance,
                    Raw_SOV__Genre_Prem_Movies_Family,
                    Raw_SOV__Genre_Prem_Movies_Horror_Thriller,
                    Raw_SOV__Genre_Prem_Movies_SciFi_Fantasy,
                    Raw_SOV__Genre_Prem_Sports_American,
                    Raw_SOV__Genre_Prem_Sports_Boxing_Wrestling,
                    Raw_SOV__Genre_Prem_Sports_Cricket,
                    Raw_SOV__Genre_Prem_Sports_Football,
                    Raw_SOV__Genre_Prem_Sports_Golf,
                    Raw_SOV__Genre_Prem_Sports_Motor_Extreme,
                    Raw_SOV__Genre_Prem_Sports_Rugby,
                    Raw_SOV__Genre_Prem_Sports_Tennis,
                    Raw_SOV__Genre_Prem_Sports_Niche_Sport,
                    Raw_SOV__Channel_BBC_News,
                    Raw_SOV__Channel_BBC1_BBC2_BBC3_BB4,
                    Raw_SOV__Channel_BT_Sports,
                    Raw_SOV__Channel_CBeebies,
                    Raw_SOV__Channel_Channel_4,
                    Raw_SOV__Channel_Channel_5,
                    Raw_SOV__Channel_Dave,
                    Raw_SOV__Channel_Discovery_All,
                    Raw_SOV__Channel_History,
                    Raw_SOV__Channel_ITV_All,
                    Raw_SOV__Channel_MTV,
                    Raw_SOV__Channel_NatGeo_All,
                    Raw_SOV__Channel_Sky_1,
                    Raw_SOV__Channel_Sky_Atlantic,
                    Raw_SOV__Channel_Sky_Living,
                    Raw_SOV__Channel_Sky_News,
                    Raw_SOV__Channel_Sky_Sports_1,
                    Raw_SOV__Channel_Sky_Sports_2,
                    Raw_SOV__Channel_Sky_Sports_F1,
                    Raw_SOV__Channel_Watch,

                    Raw_AvDNumProgs__All_TV,
                    Raw_AvDNumProgs__Non_Premium,
                    Raw_AvDNumProgs__Prem_Movies,
                    Raw_AvDNumProgs__Prem_Sports,
                    Raw_AvDNumProgs__Prem_ALa_Carte,
                    Raw_AvDNumProgs__Pack_HD,
                    Raw_AvDNumProgs__Pack_3D,
                    Raw_AvDNumProgs__Prem_3rd_Party,
                    Raw_AvDNumProgs__Non_Premium_Pay_TV,
                    Raw_AvDNumProgs__Non_Premium_FTA_TV,
                    Raw_AvDNumProgs__Recorded_Viewing,
                    Raw_AvDNumProgs__All_Pay_TV,
                    Raw_AvDNumProgs__Genre_Non_Prem_Children,
                    Raw_AvDNumProgs__Genre_Non_Prem_Movies,
                    Raw_AvDNumProgs__Genre_Non_Prem_News_Documentaries,
                    Raw_AvDNumProgs__Genre_Non_Prem_Sports,
                    Raw_AvDNumProgs__Genre_Non_Prem_Action_SciFi,
                    Raw_AvDNumProgs__Genre_Non_Prem_Arts_Lifestyle,
                    Raw_AvDNumProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    Raw_AvDNumProgs__Genre_Non_Prem_Drama_Crime,
                    Raw_AvDNumProgs__Genre_Prem_Movies_Action_Adventure,
                    Raw_AvDNumProgs__Genre_Prem_Movies_Comedy,
                    Raw_AvDNumProgs__Genre_Prem_Movies_Drama_Romance,
                    Raw_AvDNumProgs__Genre_Prem_Movies_Family,
                    Raw_AvDNumProgs__Genre_Prem_Movies_Horror_Thriller,
                    Raw_AvDNumProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    Raw_AvDNumProgs__Genre_Prem_Sports_American,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Cricket,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Football,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Golf,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Motor_Extreme,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Rugby,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Tennis,
                    Raw_AvDNumProgs__Genre_Prem_Sports_Niche_Sport,
                    Raw_AvDNumProgs__Channel_BBC_News,
                    Raw_AvDNumProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    Raw_AvDNumProgs__Channel_BT_Sports,
                    Raw_AvDNumProgs__Channel_CBeebies,
                    Raw_AvDNumProgs__Channel_Channel_4,
                    Raw_AvDNumProgs__Channel_Channel_5,
                    Raw_AvDNumProgs__Channel_Dave,
                    Raw_AvDNumProgs__Channel_Discovery_All,
                    Raw_AvDNumProgs__Channel_History,
                    Raw_AvDNumProgs__Channel_ITV_All,
                    Raw_AvDNumProgs__Channel_MTV,
                    Raw_AvDNumProgs__Channel_NatGeo_All,
                    Raw_AvDNumProgs__Channel_Sky_1,
                    Raw_AvDNumProgs__Channel_Sky_Atlantic,
                    Raw_AvDNumProgs__Channel_Sky_Living,
                    Raw_AvDNumProgs__Channel_Sky_News,
                    Raw_AvDNumProgs__Channel_Sky_Sports_1,
                    Raw_AvDNumProgs__Channel_Sky_Sports_2,
                    Raw_AvDNumProgs__Channel_Sky_Sports_F1,
                    Raw_AvDNumProgs__Channel_Watch,

                    Raw_AvDNumCompleteProgs__All_TV,
                    Raw_AvDNumCompleteProgs__Non_Premium,
                    Raw_AvDNumCompleteProgs__Prem_Movies,
                    Raw_AvDNumCompleteProgs__Prem_Sports,
                    Raw_AvDNumCompleteProgs__Prem_ALa_Carte,
                    Raw_AvDNumCompleteProgs__Pack_HD,
                    Raw_AvDNumCompleteProgs__Pack_3D,
                    Raw_AvDNumCompleteProgs__Prem_3rd_Party,
                    Raw_AvDNumCompleteProgs__Non_Premium_Pay_TV,
                    Raw_AvDNumCompleteProgs__Non_Premium_FTA_TV,
                    Raw_AvDNumCompleteProgs__Recorded_Viewing,
                    Raw_AvDNumCompleteProgs__All_Pay_TV,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_Children,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_Movies,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_News_Documentaries,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_Sports,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_Action_SciFi,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_Arts_Lifestyle,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    Raw_AvDNumCompleteProgs__Genre_Non_Prem_Drama_Crime,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Action_Adventure,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Comedy,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Drama_Romance,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Family,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Horror_Thriller,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_American,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Cricket,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Football,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Golf,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Motor_Extreme,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Rugby,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Tennis,
                    Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Niche_Sport,
                    Raw_AvDNumCompleteProgs__Channel_BBC_News,
                    Raw_AvDNumCompleteProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    Raw_AvDNumCompleteProgs__Channel_BT_Sports,
                    Raw_AvDNumCompleteProgs__Channel_CBeebies,
                    Raw_AvDNumCompleteProgs__Channel_Channel_4,
                    Raw_AvDNumCompleteProgs__Channel_Channel_5,
                    Raw_AvDNumCompleteProgs__Channel_Dave,
                    Raw_AvDNumCompleteProgs__Channel_Discovery_All,
                    Raw_AvDNumCompleteProgs__Channel_History,
                    Raw_AvDNumCompleteProgs__Channel_ITV_All,
                    Raw_AvDNumCompleteProgs__Channel_MTV,
                    Raw_AvDNumCompleteProgs__Channel_NatGeo_All,
                    Raw_AvDNumCompleteProgs__Channel_Sky_1,
                    Raw_AvDNumCompleteProgs__Channel_Sky_Atlantic,
                    Raw_AvDNumCompleteProgs__Channel_Sky_Living,
                    Raw_AvDNumCompleteProgs__Channel_Sky_News,
                    Raw_AvDNumCompleteProgs__Channel_Sky_Sports_1,
                    Raw_AvDNumCompleteProgs__Channel_Sky_Sports_2,
                    Raw_AvDNumCompleteProgs__Channel_Sky_Sports_F1,
                    Raw_AvDNumCompleteProgs__Channel_Watch,

                    Raw_Flag__Offer_Seeker
                   )

              select
                    fact.Account_Number,
                    max(prd.Period_Key),
                    min(prd.Period_Start),
                    max(prd.Period_End),

                    max(case when fact.Aggregation_Key =  21 then fact.Metric_Value else null end) as Raw_AvDVw__All_TV,
                    max(case when fact.Aggregation_Key =  91 then fact.Metric_Value else null end) as Raw_AvDVw__Non_Premium,

                    max(case when fact.Aggregation_Key =  25 then fact.Metric_Value else null end) as Raw_SOV__Prem_Movies,
                    max(case when fact.Aggregation_Key =  26 then fact.Metric_Value else null end) as Raw_SOV__Prem_Sports,
                    max(case when fact.Aggregation_Key =  27 then fact.Metric_Value else null end) as Raw_SOV__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  28 then fact.Metric_Value else null end) as Raw_SOV__Pack_HD,
                    max(case when fact.Aggregation_Key =  29 then fact.Metric_Value else null end) as Raw_SOV__Pack_3D,
                    max(case when fact.Aggregation_Key =  30 then fact.Metric_Value else null end) as Raw_SOV__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  92 then fact.Metric_Value else null end) as Raw_SOV__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  93 then fact.Metric_Value else null end) as Raw_SOV__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  37 then fact.Metric_Value else null end) as Raw_SOV__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  38 then fact.Metric_Value else null end) as Raw_SOV__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 163 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 164 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 165 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 166 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 167 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 168 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 169 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 170 then fact.Metric_Value else null end) as Raw_SOV__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 171 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 172 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 173 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 174 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 175 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 176 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 177 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 178 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 179 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 180 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 181 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 182 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 183 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 184 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 185 then fact.Metric_Value else null end) as Raw_SOV__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 292 then fact.Metric_Value else null end) as Raw_SOV__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 293 then fact.Metric_Value else null end) as Raw_SOV__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 294 then fact.Metric_Value else null end) as Raw_SOV__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 295 then fact.Metric_Value else null end) as Raw_SOV__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 296 then fact.Metric_Value else null end) as Raw_SOV__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 297 then fact.Metric_Value else null end) as Raw_SOV__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 298 then fact.Metric_Value else null end) as Raw_SOV__Channel_Dave,
                    max(case when fact.Aggregation_Key = 299 then fact.Metric_Value else null end) as Raw_SOV__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 300 then fact.Metric_Value else null end) as Raw_SOV__Channel_History,
                    max(case when fact.Aggregation_Key = 301 then fact.Metric_Value else null end) as Raw_SOV__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 302 then fact.Metric_Value else null end) as Raw_SOV__Channel_MTV,
                    max(case when fact.Aggregation_Key = 303 then fact.Metric_Value else null end) as Raw_SOV__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 304 then fact.Metric_Value else null end) as Raw_SOV__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 305 then fact.Metric_Value else null end) as Raw_SOV__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 306 then fact.Metric_Value else null end) as Raw_SOV__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 307 then fact.Metric_Value else null end) as Raw_SOV__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 308 then fact.Metric_Value else null end) as Raw_SOV__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 309 then fact.Metric_Value else null end) as Raw_SOV__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 310 then fact.Metric_Value else null end) as Raw_SOV__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 311 then fact.Metric_Value else null end) as Raw_SOV__Channel_Watch,

                    max(case when fact.Aggregation_Key =  52 then fact.Metric_Value else null end) as Raw_AvDNumProgs__All_TV,
                    max(case when fact.Aggregation_Key =  53 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Non_Premium,
                    max(case when fact.Aggregation_Key =  54 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Prem_Movies,
                    max(case when fact.Aggregation_Key =  55 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Prem_Sports,
                    max(case when fact.Aggregation_Key =  56 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  57 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Pack_HD,
                    max(case when fact.Aggregation_Key =  58 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Pack_3D,
                    max(case when fact.Aggregation_Key =  59 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  60 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  61 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  62 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  63 then fact.Metric_Value else null end) as Raw_AvDNumProgs__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 186 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 187 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 188 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 189 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 190 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 191 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 192 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 193 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 194 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 195 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 196 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 197 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 198 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 199 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 200 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 201 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 202 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 203 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 204 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 205 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 206 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 207 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 208 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 312 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 313 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 314 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 315 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 316 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 317 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 318 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Dave,
                    max(case when fact.Aggregation_Key = 319 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 320 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_History,
                    max(case when fact.Aggregation_Key = 321 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 322 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_MTV,
                    max(case when fact.Aggregation_Key = 323 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 324 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 325 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 326 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 327 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 328 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 329 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 330 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 331 then fact.Metric_Value else null end) as Raw_AvDNumProgs__Channel_Watch,

                    max(case when fact.Aggregation_Key =  76 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__All_TV,
                    max(case when fact.Aggregation_Key =  77 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Non_Premium,
                    max(case when fact.Aggregation_Key =  78 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Prem_Movies,
                    max(case when fact.Aggregation_Key =  79 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Prem_Sports,
                    max(case when fact.Aggregation_Key =  80 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  81 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Pack_HD,
                    max(case when fact.Aggregation_Key =  82 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Pack_3D,
                    max(case when fact.Aggregation_Key =  83 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  84 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  85 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  86 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  87 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 209 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 210 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 211 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 212 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 213 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 214 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 215 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 216 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 217 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 218 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 219 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 220 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 221 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 222 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 223 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 224 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 225 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 226 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 227 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 228 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 229 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 230 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 231 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 332 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 333 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 334 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 335 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 336 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 337 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 338 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Dave,
                    max(case when fact.Aggregation_Key = 339 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 340 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_History,
                    max(case when fact.Aggregation_Key = 341 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 342 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_MTV,
                    max(case when fact.Aggregation_Key = 343 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 344 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 345 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 346 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 347 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 348 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 349 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 350 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 351 then fact.Metric_Value else null end) as Raw_AvDNumCompleteProgs__Channel_Watch,

                    max(case when fact.Aggregation_Key =  39 then fact.Metric_Value else null end) as Raw_Flag__Offer_Seeker

                from VESPA_Shared.Aggr_Fact fact,
                     VESPA_Shared.Aggr_Period_Dim prd
               where fact.Period_Key = prd.Period_Key
                 and fact.Period_Key = @parPeriodKey
               group by Account_Number
            commit

            execute logger_add_event @varBuildId, 3, 'Raw metrics published', @@rowcount

        end


        -- ##############################################################################################################
        -- ##### STEP 2.0 - Table with low level values                                                             #####
        -- ##############################################################################################################
     if (@parRunLowLevel = 1)
        begin

            delete from VESPA_Shared.Aggr_Summary_Low_Level_All
             where Period_Key = @parPeriodKey
            commit
            execute logger_add_event @varBuildId, 3, 'Existing summaries deleted (low level)', @@rowcount

            insert into VESPA_Shared.Aggr_Summary_Low_Level_All
                   (
                    Account_Number,
                    Period_Key,
                    Period_Start,
                    Period_End,

                    LL_AvDVw__All_TV,
                    LL_AvDVw__Non_Premium,

                    LL_SOV__Prem_Movies,
                    LL_SOV__Prem_Sports,
                    LL_SOV__Prem_ALa_Carte,
                    LL_SOV__Pack_HD,
                    LL_SOV__Pack_3D,
                    LL_SOV__Prem_3rd_Party,
                    LL_SOV__Non_Premium_Pay_TV,
                    LL_SOV__Non_Premium_FTA_TV,
                    LL_SOV__Recorded_Viewing,
                    LL_SOV__All_Pay_TV,
                    LL_SOV__Genre_Non_Prem_Children,
                    LL_SOV__Genre_Non_Prem_Movies,
                    LL_SOV__Genre_Non_Prem_News_Documentaries,
                    LL_SOV__Genre_Non_Prem_Sports,
                    LL_SOV__Genre_Non_Prem_Action_SciFi,
                    LL_SOV__Genre_Non_Prem_Arts_Lifestyle,
                    LL_SOV__Genre_Non_Prem_Comedy_Game_Shows,
                    LL_SOV__Genre_Non_Prem_Drama_Crime,
                    LL_SOV__Genre_Prem_Movies_Action_Adventure,
                    LL_SOV__Genre_Prem_Movies_Comedy,
                    LL_SOV__Genre_Prem_Movies_Drama_Romance,
                    LL_SOV__Genre_Prem_Movies_Family,
                    LL_SOV__Genre_Prem_Movies_Horror_Thriller,
                    LL_SOV__Genre_Prem_Movies_SciFi_Fantasy,
                    LL_SOV__Genre_Prem_Sports_American,
                    LL_SOV__Genre_Prem_Sports_Boxing_Wrestling,
                    LL_SOV__Genre_Prem_Sports_Cricket,
                    LL_SOV__Genre_Prem_Sports_Football,
                    LL_SOV__Genre_Prem_Sports_Golf,
                    LL_SOV__Genre_Prem_Sports_Motor_Extreme,
                    LL_SOV__Genre_Prem_Sports_Rugby,
                    LL_SOV__Genre_Prem_Sports_Tennis,
                    LL_SOV__Genre_Prem_Sports_Niche_Sport,
                    LL_SOV__Channel_BBC_News,
                    LL_SOV__Channel_BBC1_BBC2_BBC3_BB4,
                    LL_SOV__Channel_BT_Sports,
                    LL_SOV__Channel_CBeebies,
                    LL_SOV__Channel_Channel_4,
                    LL_SOV__Channel_Channel_5,
                    LL_SOV__Channel_Dave,
                    LL_SOV__Channel_Discovery_All,
                    LL_SOV__Channel_History,
                    LL_SOV__Channel_ITV_All,
                    LL_SOV__Channel_MTV,
                    LL_SOV__Channel_NatGeo_All,
                    LL_SOV__Channel_Sky_1,
                    LL_SOV__Channel_Sky_Atlantic,
                    LL_SOV__Channel_Sky_Living,
                    LL_SOV__Channel_Sky_News,
                    LL_SOV__Channel_Sky_Sports_1,
                    LL_SOV__Channel_Sky_Sports_2,
                    LL_SOV__Channel_Sky_Sports_F1,
                    LL_SOV__Channel_Watch,

                    LL_AvDNumProgs__All_TV,
                    LL_AvDNumProgs__Non_Premium,
                    LL_AvDNumProgs__Prem_Movies,
                    LL_AvDNumProgs__Prem_Sports,
                    LL_AvDNumProgs__Prem_ALa_Carte,
                    LL_AvDNumProgs__Pack_HD,
                    LL_AvDNumProgs__Pack_3D,
                    LL_AvDNumProgs__Prem_3rd_Party,
                    LL_AvDNumProgs__Non_Premium_Pay_TV,
                    LL_AvDNumProgs__Non_Premium_FTA_TV,
                    LL_AvDNumProgs__Recorded_Viewing,
                    LL_AvDNumProgs__All_Pay_TV,
                    LL_AvDNumProgs__Genre_Non_Prem_Children,
                    LL_AvDNumProgs__Genre_Non_Prem_Movies,
                    LL_AvDNumProgs__Genre_Non_Prem_News_Documentaries,
                    LL_AvDNumProgs__Genre_Non_Prem_Sports,
                    LL_AvDNumProgs__Genre_Non_Prem_Action_SciFi,
                    LL_AvDNumProgs__Genre_Non_Prem_Arts_Lifestyle,
                    LL_AvDNumProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    LL_AvDNumProgs__Genre_Non_Prem_Drama_Crime,
                    LL_AvDNumProgs__Genre_Prem_Movies_Action_Adventure,
                    LL_AvDNumProgs__Genre_Prem_Movies_Comedy,
                    LL_AvDNumProgs__Genre_Prem_Movies_Drama_Romance,
                    LL_AvDNumProgs__Genre_Prem_Movies_Family,
                    LL_AvDNumProgs__Genre_Prem_Movies_Horror_Thriller,
                    LL_AvDNumProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    LL_AvDNumProgs__Genre_Prem_Sports_American,
                    LL_AvDNumProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    LL_AvDNumProgs__Genre_Prem_Sports_Cricket,
                    LL_AvDNumProgs__Genre_Prem_Sports_Football,
                    LL_AvDNumProgs__Genre_Prem_Sports_Golf,
                    LL_AvDNumProgs__Genre_Prem_Sports_Motor_Extreme,
                    LL_AvDNumProgs__Genre_Prem_Sports_Rugby,
                    LL_AvDNumProgs__Genre_Prem_Sports_Tennis,
                    LL_AvDNumProgs__Genre_Prem_Sports_Niche_Sport,
                    LL_AvDNumProgs__Channel_BBC_News,
                    LL_AvDNumProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    LL_AvDNumProgs__Channel_BT_Sports,
                    LL_AvDNumProgs__Channel_CBeebies,
                    LL_AvDNumProgs__Channel_Channel_4,
                    LL_AvDNumProgs__Channel_Channel_5,
                    LL_AvDNumProgs__Channel_Dave,
                    LL_AvDNumProgs__Channel_Discovery_All,
                    LL_AvDNumProgs__Channel_History,
                    LL_AvDNumProgs__Channel_ITV_All,
                    LL_AvDNumProgs__Channel_MTV,
                    LL_AvDNumProgs__Channel_NatGeo_All,
                    LL_AvDNumProgs__Channel_Sky_1,
                    LL_AvDNumProgs__Channel_Sky_Atlantic,
                    LL_AvDNumProgs__Channel_Sky_Living,
                    LL_AvDNumProgs__Channel_Sky_News,
                    LL_AvDNumProgs__Channel_Sky_Sports_1,
                    LL_AvDNumProgs__Channel_Sky_Sports_2,
                    LL_AvDNumProgs__Channel_Sky_Sports_F1,
                    LL_AvDNumProgs__Channel_Watch,

                    LL_AvDNumCompleteProgs__All_TV,
                    LL_AvDNumCompleteProgs__Non_Premium,
                    LL_AvDNumCompleteProgs__Prem_Movies,
                    LL_AvDNumCompleteProgs__Prem_Sports,
                    LL_AvDNumCompleteProgs__Prem_ALa_Carte,
                    LL_AvDNumCompleteProgs__Pack_HD,
                    LL_AvDNumCompleteProgs__Pack_3D,
                    LL_AvDNumCompleteProgs__Prem_3rd_Party,
                    LL_AvDNumCompleteProgs__Non_Premium_Pay_TV,
                    LL_AvDNumCompleteProgs__Non_Premium_FTA_TV,
                    LL_AvDNumCompleteProgs__Recorded_Viewing,
                    LL_AvDNumCompleteProgs__All_Pay_TV,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_Children,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_Movies,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_News_Documentaries,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_Sports,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_Action_SciFi,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_Arts_Lifestyle,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    LL_AvDNumCompleteProgs__Genre_Non_Prem_Drama_Crime,
                    LL_AvDNumCompleteProgs__Genre_Prem_Movies_Action_Adventure,
                    LL_AvDNumCompleteProgs__Genre_Prem_Movies_Comedy,
                    LL_AvDNumCompleteProgs__Genre_Prem_Movies_Drama_Romance,
                    LL_AvDNumCompleteProgs__Genre_Prem_Movies_Family,
                    LL_AvDNumCompleteProgs__Genre_Prem_Movies_Horror_Thriller,
                    LL_AvDNumCompleteProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_American,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Cricket,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Football,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Golf,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Motor_Extreme,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Rugby,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Tennis,
                    LL_AvDNumCompleteProgs__Genre_Prem_Sports_Niche_Sport,
                    LL_AvDNumCompleteProgs__Channel_BBC_News,
                    LL_AvDNumCompleteProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    LL_AvDNumCompleteProgs__Channel_BT_Sports,
                    LL_AvDNumCompleteProgs__Channel_CBeebies,
                    LL_AvDNumCompleteProgs__Channel_Channel_4,
                    LL_AvDNumCompleteProgs__Channel_Channel_5,
                    LL_AvDNumCompleteProgs__Channel_Dave,
                    LL_AvDNumCompleteProgs__Channel_Discovery_All,
                    LL_AvDNumCompleteProgs__Channel_History,
                    LL_AvDNumCompleteProgs__Channel_ITV_All,
                    LL_AvDNumCompleteProgs__Channel_MTV,
                    LL_AvDNumCompleteProgs__Channel_NatGeo_All,
                    LL_AvDNumCompleteProgs__Channel_Sky_1,
                    LL_AvDNumCompleteProgs__Channel_Sky_Atlantic,
                    LL_AvDNumCompleteProgs__Channel_Sky_Living,
                    LL_AvDNumCompleteProgs__Channel_Sky_News,
                    LL_AvDNumCompleteProgs__Channel_Sky_Sports_1,
                    LL_AvDNumCompleteProgs__Channel_Sky_Sports_2,
                    LL_AvDNumCompleteProgs__Channel_Sky_Sports_F1,
                    LL_AvDNumCompleteProgs__Channel_Watch
                   )

              select
                    fact.Account_Number,
                    max(prd.Period_Key),
                    min(prd.Period_Start),
                    max(prd.Period_End),

                    max(case when fact.Aggregation_Key =  21 then mtd.Low_Level_Banding else null end) as LL_AvDVw__All_TV,
                    max(case when fact.Aggregation_Key =  91 then mtd.Low_Level_Banding else null end) as LL_AvDVw__Non_Premium,

                    max(case when fact.Aggregation_Key =  25 then mtd.Low_Level_Banding else null end) as LL_SOV__Prem_Movies,
                    max(case when fact.Aggregation_Key =  26 then mtd.Low_Level_Banding else null end) as LL_SOV__Prem_Sports,
                    max(case when fact.Aggregation_Key =  27 then mtd.Low_Level_Banding else null end) as LL_SOV__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  28 then mtd.Low_Level_Banding else null end) as LL_SOV__Pack_HD,
                    max(case when fact.Aggregation_Key =  29 then mtd.Low_Level_Banding else null end) as LL_SOV__Pack_3D,
                    max(case when fact.Aggregation_Key =  30 then mtd.Low_Level_Banding else null end) as LL_SOV__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  92 then mtd.Low_Level_Banding else null end) as LL_SOV__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  93 then mtd.Low_Level_Banding else null end) as LL_SOV__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  37 then mtd.Low_Level_Banding else null end) as LL_SOV__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  38 then mtd.Low_Level_Banding else null end) as LL_SOV__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 163 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 164 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 165 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 166 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 167 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 168 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 169 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 170 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 171 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 172 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 173 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 174 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 175 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 176 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 177 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 178 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 179 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 180 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 181 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 182 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 183 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 184 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 185 then mtd.Low_Level_Banding else null end) as LL_SOV__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 292 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 293 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 294 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 295 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 296 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 297 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 298 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Dave,
                    max(case when fact.Aggregation_Key = 299 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 300 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_History,
                    max(case when fact.Aggregation_Key = 301 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 302 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_MTV,
                    max(case when fact.Aggregation_Key = 303 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 304 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 305 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 306 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 307 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 308 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 309 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 310 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 311 then mtd.Low_Level_Banding else null end) as LL_SOV__Channel_Watch,

                    max(case when fact.Aggregation_Key =  52 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__All_TV,
                    max(case when fact.Aggregation_Key =  53 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Non_Premium,
                    max(case when fact.Aggregation_Key =  54 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Prem_Movies,
                    max(case when fact.Aggregation_Key =  55 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Prem_Sports,
                    max(case when fact.Aggregation_Key =  56 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  57 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Pack_HD,
                    max(case when fact.Aggregation_Key =  58 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Pack_3D,
                    max(case when fact.Aggregation_Key =  59 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  60 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  61 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  62 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  63 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 186 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 187 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 188 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 189 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 190 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 191 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 192 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 193 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 194 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 195 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 196 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 197 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 198 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 199 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 200 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 201 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 202 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 203 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 204 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 205 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 206 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 207 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 208 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 312 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 313 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 314 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 315 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 316 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 317 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 318 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Dave,
                    max(case when fact.Aggregation_Key = 319 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 320 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_History,
                    max(case when fact.Aggregation_Key = 321 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 322 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_MTV,
                    max(case when fact.Aggregation_Key = 323 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 324 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 325 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 326 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 327 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 328 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 329 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 330 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 331 then mtd.Low_Level_Banding else null end) as LL_AvDNumProgs__Channel_Watch,

                    max(case when fact.Aggregation_Key =  76 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__All_TV,
                    max(case when fact.Aggregation_Key =  77 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Non_Premium,
                    max(case when fact.Aggregation_Key =  78 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Prem_Movies,
                    max(case when fact.Aggregation_Key =  79 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Prem_Sports,
                    max(case when fact.Aggregation_Key =  80 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  81 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Pack_HD,
                    max(case when fact.Aggregation_Key =  82 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Pack_3D,
                    max(case when fact.Aggregation_Key =  83 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  84 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  85 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  86 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  87 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 209 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 210 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 211 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 212 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 213 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 214 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 215 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 216 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 217 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 218 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 219 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 220 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 221 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 222 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 223 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 224 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 225 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 226 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 227 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 228 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 229 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 230 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 231 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 332 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 333 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 334 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 335 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 336 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 337 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 338 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Dave,
                    max(case when fact.Aggregation_Key = 339 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 340 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_History,
                    max(case when fact.Aggregation_Key = 341 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 342 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_MTV,
                    max(case when fact.Aggregation_Key = 343 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 344 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 345 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 346 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 347 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 348 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 349 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 350 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 351 then mtd.Low_Level_Banding else null end) as LL_AvDNumCompleteProgs__Channel_Watch

                from VESPA_Shared.Aggr_Fact fact,
                     VESPA_Shared.Aggr_Period_Dim prd,
                     VESPA_Shared.Aggr_Metric_Group_Dim mtd
               where fact.Period_Key = prd.Period_Key
                 and fact.Metric_Group_Key = mtd.Metric_Group_Key
                 and fact.Period_Key = @parPeriodKey
               group by Account_Number
            commit

            execute logger_add_event @varBuildId, 3, 'Low level grouping published', @@rowcount

        end


        -- ##############################################################################################################
        -- ##### STEP 3.0 - Table with high level values                                                            #####
        -- ##############################################################################################################
      if (@parRunHighLevel = 1)
        begin

            delete from VESPA_Shared.Aggr_Summary_High_Level_All
             where Period_Key = @parPeriodKey
            commit
            execute logger_add_event @varBuildId, 3, 'Existing summaries deleted (high level)', @@rowcount

            insert into VESPA_Shared.Aggr_Summary_High_Level_All
                   (
                    Account_Number,
                    Period_Key,
                    Period_Start,
                    Period_End,

                    HL_AvDVw__All_TV,
                    HL_AvDVw__Non_Premium,

                    HL_SOV__Prem_Movies,
                    HL_SOV__Prem_Sports,
                    HL_SOV__Prem_ALa_Carte,
                    HL_SOV__Pack_HD,
                    HL_SOV__Pack_3D,
                    HL_SOV__Prem_3rd_Party,
                    HL_SOV__Non_Premium_Pay_TV,
                    HL_SOV__Non_Premium_FTA_TV,
                    HL_SOV__Recorded_Viewing,
                    HL_SOV__All_Pay_TV,
                    HL_SOV__Genre_Non_Prem_Children,
                    HL_SOV__Genre_Non_Prem_Movies,
                    HL_SOV__Genre_Non_Prem_News_Documentaries,
                    HL_SOV__Genre_Non_Prem_Sports,
                    HL_SOV__Genre_Non_Prem_Action_SciFi,
                    HL_SOV__Genre_Non_Prem_Arts_Lifestyle,
                    HL_SOV__Genre_Non_Prem_Comedy_Game_Shows,
                    HL_SOV__Genre_Non_Prem_Drama_Crime,
                    HL_SOV__Genre_Prem_Movies_Action_Adventure,
                    HL_SOV__Genre_Prem_Movies_Comedy,
                    HL_SOV__Genre_Prem_Movies_Drama_Romance,
                    HL_SOV__Genre_Prem_Movies_Family,
                    HL_SOV__Genre_Prem_Movies_Horror_Thriller,
                    HL_SOV__Genre_Prem_Movies_SciFi_Fantasy,
                    HL_SOV__Genre_Prem_Sports_American,
                    HL_SOV__Genre_Prem_Sports_Boxing_Wrestling,
                    HL_SOV__Genre_Prem_Sports_Cricket,
                    HL_SOV__Genre_Prem_Sports_Football,
                    HL_SOV__Genre_Prem_Sports_Golf,
                    HL_SOV__Genre_Prem_Sports_Motor_Extreme,
                    HL_SOV__Genre_Prem_Sports_Rugby,
                    HL_SOV__Genre_Prem_Sports_Tennis,
                    HL_SOV__Genre_Prem_Sports_Niche_Sport,
                    HL_SOV__Channel_BBC_News,
                    HL_SOV__Channel_BBC1_BBC2_BBC3_BB4,
                    HL_SOV__Channel_BT_Sports,
                    HL_SOV__Channel_CBeebies,
                    HL_SOV__Channel_Channel_4,
                    HL_SOV__Channel_Channel_5,
                    HL_SOV__Channel_Dave,
                    HL_SOV__Channel_Discovery_All,
                    HL_SOV__Channel_History,
                    HL_SOV__Channel_ITV_All,
                    HL_SOV__Channel_MTV,
                    HL_SOV__Channel_NatGeo_All,
                    HL_SOV__Channel_Sky_1,
                    HL_SOV__Channel_Sky_Atlantic,
                    HL_SOV__Channel_Sky_Living,
                    HL_SOV__Channel_Sky_News,
                    HL_SOV__Channel_Sky_Sports_1,
                    HL_SOV__Channel_Sky_Sports_2,
                    HL_SOV__Channel_Sky_Sports_F1,
                    HL_SOV__Channel_Watch,


                    HL_AvDNumProgs__All_TV,
                    HL_AvDNumProgs__Non_Premium,
                    HL_AvDNumProgs__Prem_Movies,
                    HL_AvDNumProgs__Prem_Sports,
                    HL_AvDNumProgs__Prem_ALa_Carte,
                    HL_AvDNumProgs__Pack_HD,
                    HL_AvDNumProgs__Pack_3D,
                    HL_AvDNumProgs__Prem_3rd_Party,
                    HL_AvDNumProgs__Non_Premium_Pay_TV,
                    HL_AvDNumProgs__Non_Premium_FTA_TV,
                    HL_AvDNumProgs__Recorded_Viewing,
                    HL_AvDNumProgs__All_Pay_TV,
                    HL_AvDNumProgs__Genre_Non_Prem_Children,
                    HL_AvDNumProgs__Genre_Non_Prem_Movies,
                    HL_AvDNumProgs__Genre_Non_Prem_News_Documentaries,
                    HL_AvDNumProgs__Genre_Non_Prem_Sports,
                    HL_AvDNumProgs__Genre_Non_Prem_Action_SciFi,
                    HL_AvDNumProgs__Genre_Non_Prem_Arts_Lifestyle,
                    HL_AvDNumProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    HL_AvDNumProgs__Genre_Non_Prem_Drama_Crime,
                    HL_AvDNumProgs__Genre_Prem_Movies_Action_Adventure,
                    HL_AvDNumProgs__Genre_Prem_Movies_Comedy,
                    HL_AvDNumProgs__Genre_Prem_Movies_Drama_Romance,
                    HL_AvDNumProgs__Genre_Prem_Movies_Family,
                    HL_AvDNumProgs__Genre_Prem_Movies_Horror_Thriller,
                    HL_AvDNumProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    HL_AvDNumProgs__Genre_Prem_Sports_American,
                    HL_AvDNumProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    HL_AvDNumProgs__Genre_Prem_Sports_Cricket,
                    HL_AvDNumProgs__Genre_Prem_Sports_Football,
                    HL_AvDNumProgs__Genre_Prem_Sports_Golf,
                    HL_AvDNumProgs__Genre_Prem_Sports_Motor_Extreme,
                    HL_AvDNumProgs__Genre_Prem_Sports_Rugby,
                    HL_AvDNumProgs__Genre_Prem_Sports_Tennis,
                    HL_AvDNumProgs__Genre_Prem_Sports_Niche_Sport,
                    HL_AvDNumProgs__Channel_BBC_News,
                    HL_AvDNumProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    HL_AvDNumProgs__Channel_BT_Sports,
                    HL_AvDNumProgs__Channel_CBeebies,
                    HL_AvDNumProgs__Channel_Channel_4,
                    HL_AvDNumProgs__Channel_Channel_5,
                    HL_AvDNumProgs__Channel_Dave,
                    HL_AvDNumProgs__Channel_Discovery_All,
                    HL_AvDNumProgs__Channel_History,
                    HL_AvDNumProgs__Channel_ITV_All,
                    HL_AvDNumProgs__Channel_MTV,
                    HL_AvDNumProgs__Channel_NatGeo_All,
                    HL_AvDNumProgs__Channel_Sky_1,
                    HL_AvDNumProgs__Channel_Sky_Atlantic,
                    HL_AvDNumProgs__Channel_Sky_Living,
                    HL_AvDNumProgs__Channel_Sky_News,
                    HL_AvDNumProgs__Channel_Sky_Sports_1,
                    HL_AvDNumProgs__Channel_Sky_Sports_2,
                    HL_AvDNumProgs__Channel_Sky_Sports_F1,
                    HL_AvDNumProgs__Channel_Watch,

                    HL_AvDNumCompleteProgs__All_TV,
                    HL_AvDNumCompleteProgs__Non_Premium,
                    HL_AvDNumCompleteProgs__Prem_Movies,
                    HL_AvDNumCompleteProgs__Prem_Sports,
                    HL_AvDNumCompleteProgs__Prem_ALa_Carte,
                    HL_AvDNumCompleteProgs__Pack_HD,
                    HL_AvDNumCompleteProgs__Pack_3D,
                    HL_AvDNumCompleteProgs__Prem_3rd_Party,
                    HL_AvDNumCompleteProgs__Non_Premium_Pay_TV,
                    HL_AvDNumCompleteProgs__Non_Premium_FTA_TV,
                    HL_AvDNumCompleteProgs__Recorded_Viewing,
                    HL_AvDNumCompleteProgs__All_Pay_TV,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_Children,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_Movies,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_News_Documentaries,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_Sports,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_Action_SciFi,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_Arts_Lifestyle,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    HL_AvDNumCompleteProgs__Genre_Non_Prem_Drama_Crime,
                    HL_AvDNumCompleteProgs__Genre_Prem_Movies_Action_Adventure,
                    HL_AvDNumCompleteProgs__Genre_Prem_Movies_Comedy,
                    HL_AvDNumCompleteProgs__Genre_Prem_Movies_Drama_Romance,
                    HL_AvDNumCompleteProgs__Genre_Prem_Movies_Family,
                    HL_AvDNumCompleteProgs__Genre_Prem_Movies_Horror_Thriller,
                    HL_AvDNumCompleteProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_American,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Cricket,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Football,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Golf,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Motor_Extreme,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Rugby,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Tennis,
                    HL_AvDNumCompleteProgs__Genre_Prem_Sports_Niche_Sport,
                    HL_AvDNumCompleteProgs__Channel_BBC_News,
                    HL_AvDNumCompleteProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    HL_AvDNumCompleteProgs__Channel_BT_Sports,
                    HL_AvDNumCompleteProgs__Channel_CBeebies,
                    HL_AvDNumCompleteProgs__Channel_Channel_4,
                    HL_AvDNumCompleteProgs__Channel_Channel_5,
                    HL_AvDNumCompleteProgs__Channel_Dave,
                    HL_AvDNumCompleteProgs__Channel_Discovery_All,
                    HL_AvDNumCompleteProgs__Channel_History,
                    HL_AvDNumCompleteProgs__Channel_ITV_All,
                    HL_AvDNumCompleteProgs__Channel_MTV,
                    HL_AvDNumCompleteProgs__Channel_NatGeo_All,
                    HL_AvDNumCompleteProgs__Channel_Sky_1,
                    HL_AvDNumCompleteProgs__Channel_Sky_Atlantic,
                    HL_AvDNumCompleteProgs__Channel_Sky_Living,
                    HL_AvDNumCompleteProgs__Channel_Sky_News,
                    HL_AvDNumCompleteProgs__Channel_Sky_Sports_1,
                    HL_AvDNumCompleteProgs__Channel_Sky_Sports_2,
                    HL_AvDNumCompleteProgs__Channel_Sky_Sports_F1,
                    HL_AvDNumCompleteProgs__Channel_Watch
                   )

              select
                    fact.Account_Number,
                    max(prd.Period_Key),
                    min(prd.Period_Start),
                    max(prd.Period_End),

                    max(case when fact.Aggregation_Key =  21 then mtd.High_Level_Banding else null end) as HL_AvDVw__All_TV,
                    max(case when fact.Aggregation_Key =  91 then mtd.High_Level_Banding else null end) as HL_AvDVw__Non_Premium,

                    max(case when fact.Aggregation_Key =  25 then mtd.High_Level_Banding else null end) as HL_SOV__Prem_Movies,
                    max(case when fact.Aggregation_Key =  26 then mtd.High_Level_Banding else null end) as HL_SOV__Prem_Sports,
                    max(case when fact.Aggregation_Key =  27 then mtd.High_Level_Banding else null end) as HL_SOV__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  28 then mtd.High_Level_Banding else null end) as HL_SOV__Pack_HD,
                    max(case when fact.Aggregation_Key =  29 then mtd.High_Level_Banding else null end) as HL_SOV__Pack_3D,
                    max(case when fact.Aggregation_Key =  30 then mtd.High_Level_Banding else null end) as HL_SOV__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  92 then mtd.High_Level_Banding else null end) as HL_SOV__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  93 then mtd.High_Level_Banding else null end) as HL_SOV__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  37 then mtd.High_Level_Banding else null end) as HL_SOV__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  38 then mtd.High_Level_Banding else null end) as HL_SOV__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 163 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 164 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 165 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 166 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 167 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 168 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 169 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 170 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 171 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 172 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 173 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 174 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 175 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 176 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 177 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 178 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 179 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 180 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 181 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 182 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 183 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 184 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 185 then mtd.High_Level_Banding else null end) as HL_SOV__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 292 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 293 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 294 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 295 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 296 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 297 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 298 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Dave,
                    max(case when fact.Aggregation_Key = 299 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 300 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_History,
                    max(case when fact.Aggregation_Key = 301 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 302 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_MTV,
                    max(case when fact.Aggregation_Key = 303 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 304 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 305 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 306 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 307 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 308 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 309 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 310 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 311 then mtd.High_Level_Banding else null end) as HL_SOV__Channel_Watch,


                    max(case when fact.Aggregation_Key =  52 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__All_TV,
                    max(case when fact.Aggregation_Key =  53 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Non_Premium,
                    max(case when fact.Aggregation_Key =  54 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Prem_Movies,
                    max(case when fact.Aggregation_Key =  55 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Prem_Sports,
                    max(case when fact.Aggregation_Key =  56 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  57 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Pack_HD,
                    max(case when fact.Aggregation_Key =  58 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Pack_3D,
                    max(case when fact.Aggregation_Key =  59 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  60 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  61 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  62 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  63 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 186 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 187 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 188 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 189 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 190 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 191 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 192 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 193 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 194 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 195 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 196 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 197 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 198 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 199 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 200 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 201 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 202 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 203 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 204 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 205 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 206 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 207 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 208 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 312 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 313 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 314 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 315 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 316 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 317 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 318 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Dave,
                    max(case when fact.Aggregation_Key = 319 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 320 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_History,
                    max(case when fact.Aggregation_Key = 321 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 322 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_MTV,
                    max(case when fact.Aggregation_Key = 323 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 324 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 325 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 326 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 327 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 328 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 329 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 330 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 331 then mtd.High_Level_Banding else null end) as HL_AvDNumProgs__Channel_Watch,

                    max(case when fact.Aggregation_Key =  76 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__All_TV,
                    max(case when fact.Aggregation_Key =  77 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Non_Premium,
                    max(case when fact.Aggregation_Key =  78 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Prem_Movies,
                    max(case when fact.Aggregation_Key =  79 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Prem_Sports,
                    max(case when fact.Aggregation_Key =  80 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Prem_ALa_Carte,
                    max(case when fact.Aggregation_Key =  81 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Pack_HD,
                    max(case when fact.Aggregation_Key =  82 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Pack_3D,
                    max(case when fact.Aggregation_Key =  83 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Prem_3rd_Party,
                    max(case when fact.Aggregation_Key =  84 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Non_Premium_Pay_TV,
                    max(case when fact.Aggregation_Key =  85 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Non_Premium_FTA_TV,
                    max(case when fact.Aggregation_Key =  86 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Recorded_Viewing,
                    max(case when fact.Aggregation_Key =  87 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__All_Pay_TV,
                    max(case when fact.Aggregation_Key = 209 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_Children,
                    max(case when fact.Aggregation_Key = 210 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_Movies,
                    max(case when fact.Aggregation_Key = 211 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_News_Documentaries,
                    max(case when fact.Aggregation_Key = 212 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_Sports,
                    max(case when fact.Aggregation_Key = 213 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_Action_SciFi,
                    max(case when fact.Aggregation_Key = 214 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_Arts_Lifestyle,
                    max(case when fact.Aggregation_Key = 215 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_Comedy_Game_Shows,
                    max(case when fact.Aggregation_Key = 216 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Non_Prem_Drama_Crime,
                    max(case when fact.Aggregation_Key = 217 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Movies_Action_Adventure,
                    max(case when fact.Aggregation_Key = 218 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Movies_Comedy,
                    max(case when fact.Aggregation_Key = 219 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Movies_Drama_Romance,
                    max(case when fact.Aggregation_Key = 220 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Movies_Family,
                    max(case when fact.Aggregation_Key = 221 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Movies_Horror_Thriller,
                    max(case when fact.Aggregation_Key = 222 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Movies_SciFi_Fantasy,
                    max(case when fact.Aggregation_Key = 223 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_American,
                    max(case when fact.Aggregation_Key = 224 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Boxing_Wrestling,
                    max(case when fact.Aggregation_Key = 225 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Cricket,
                    max(case when fact.Aggregation_Key = 226 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Football,
                    max(case when fact.Aggregation_Key = 227 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Golf,
                    max(case when fact.Aggregation_Key = 228 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Motor_Extreme,
                    max(case when fact.Aggregation_Key = 229 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Rugby,
                    max(case when fact.Aggregation_Key = 230 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Tennis,
                    max(case when fact.Aggregation_Key = 231 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Genre_Prem_Sports_Niche_Sport,
                    max(case when fact.Aggregation_Key = 332 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_BBC_News,
                    max(case when fact.Aggregation_Key = 333 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_BBC1_BBC2_BBC3_BB4,
                    max(case when fact.Aggregation_Key = 334 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_BT_Sports,
                    max(case when fact.Aggregation_Key = 335 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_CBeebies,
                    max(case when fact.Aggregation_Key = 336 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Channel_4,
                    max(case when fact.Aggregation_Key = 337 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Channel_5,
                    max(case when fact.Aggregation_Key = 338 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Dave,
                    max(case when fact.Aggregation_Key = 339 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Discovery_All,
                    max(case when fact.Aggregation_Key = 340 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_History,
                    max(case when fact.Aggregation_Key = 341 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_ITV_All,
                    max(case when fact.Aggregation_Key = 342 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_MTV,
                    max(case when fact.Aggregation_Key = 343 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_NatGeo_All,
                    max(case when fact.Aggregation_Key = 344 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Sky_1,
                    max(case when fact.Aggregation_Key = 345 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Sky_Atlantic,
                    max(case when fact.Aggregation_Key = 346 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Sky_Living,
                    max(case when fact.Aggregation_Key = 347 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Sky_News,
                    max(case when fact.Aggregation_Key = 348 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Sky_Sports_1,
                    max(case when fact.Aggregation_Key = 349 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Sky_Sports_2,
                    max(case when fact.Aggregation_Key = 350 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Sky_Sports_F1,
                    max(case when fact.Aggregation_Key = 351 then mtd.High_Level_Banding else null end) as HL_AvDNumCompleteProgs__Channel_Watch

                from VESPA_Shared.Aggr_Fact fact,
                     VESPA_Shared.Aggr_Period_Dim prd,
                     VESPA_Shared.Aggr_Metric_Group_Dim mtd
               where fact.Period_Key = prd.Period_Key
                 and fact.Metric_Group_Key = mtd.Metric_Group_Key
                 and fact.Period_Key = @parPeriodKey
               group by Account_Number
            commit

            execute logger_add_event @varBuildId, 3, 'High level grouping published', @@rowcount

        end


        -- ##############################################################################################################
      execute logger_add_event @varBuildId, 3, '####### VESPA Aggregations [Aggregation publishing] - process completed #######', null
      execute logger_add_event @varBuildId, 3, ' ', null
      commit

end;




